{% extends 'plantilla.html' %}

{% block title %}Editar Mascota{% endblock %}

{% block extra_head %}
<style>
    .form-container {
        max-width: 650px;
        margin: 0 auto;
    }
</style>
{% endblock %}

{% block contenido %}
<div class="page-heading">
    <h3 class="text-center mb-4">Editar Mascota: {{ mascota.nombre }}</h3>
</div>

<section class="section">
    <div class="card shadow p-4 form-container">
        <div class="card-body">
            <form id="formMascota" method="POST" novalidate>
                {% csrf_token %}

                <div class="mb-3">
                    <label for="nombre" class="form-label">Nombre:</label>
                    <input type="text" class="form-control" id="nombre" name="nombre" 
                           value="{{ mascota.nombre }}" required>
                </div>

                <div class="mb-3">
                    <label for="especie" class="form-label">Especie:</label>
                    <select class="form-select" id="especie" name="especie" required>
                        <option value="">Seleccionar especie...</option>
                        <option value="Canina" {% if mascota.especie == "Canina" %}selected{% endif %}>Canina</option>
                        <option value="Felina" {% if mascota.especie == "Felina" %}selected{% endif %}>Felina</option>
                        <option value="Aviar" {% if mascota.especie == "Aviar" %}selected{% endif %}>Aviar</option>
                        <option value="Reptil" {% if mascota.especie == "Reptil" %}selected{% endif %}>Reptil</option>
                        <option value="Otro" {% if mascota.especie == "Otro" %}selected{% endif %}>Otro</option>
                    </select>
                </div>

                <div class="mb-3" id="grupoRaza">
                    <label for="raza" class="form-label">Raza:</label>
                    <select class="form-select" id="raza" name="raza">
                        <option value="">Seleccione una raza...</option>
                    </select>
                </div>

                <div class="mb-3">
                    <label for="edad" class="form-label">Edad:</label>
                    <input type="number" class="form-control" id="edad" name="edad" 
                           value="{{ mascota.edad }}" required>
                </div>

                <div class="mb-3">
                    <label for="sexo" class="form-label">Sexo:</label>
                    <select class="form-select" id="sexo" name="sexo" required>
                        <option value="">Seleccionar...</option>
                        <option value="Macho" {% if mascota.sexo == "Macho" %}selected{% endif %}>Macho</option>
                        <option value="Hembra" {% if mascota.sexo == "Hembra" %}selected{% endif %}>Hembra</option>
                    </select>
                </div>

                <div class="mb-3">
                    <label for="descripcion" class="form-label">Descripción:</label>
                    <textarea class="form-control" id="descripcion" name="descripcion" rows="3">{{ mascota.descripcion }}</textarea>
                </div>

                <div class="mb-3">
                    <label for="fecha_rescate" class="form-label">Fecha de rescate:</label>
                    <input type="date" class="form-control" id="fecha_rescate" name="fecha_rescate" 
                           value="{{ mascota.fecha_rescate|date:'Y-m-d' }}">
                </div>

                <div class="mb-3">
                    <label for="dueño" class="form-label">Dueño:</label>
                    <select class="form-select" id="dueño" name="dueño">
                        <option value="">Seleccionar dueño</option>
                        {% for persona in personas %}
                            <option value="{{ persona.id }}" 
                                {% if mascota.dueño and mascota.dueño.id == persona.id %}selected{% endif %}>
                                {{ persona.nombre }} {{ persona.apellido }}
                            </option>
                        {% endfor %}
                    </select>
                </div>

                <div class="form-check mb-4">
                    <input type="checkbox" class="form-check-input" id="adoptado" name="adoptado"
                           {% if mascota.adoptado %}checked{% endif %}>
                    <label class="form-check-label" for="adoptado">Adoptado</label>
                </div>

                <div class="d-flex justify-content-between">
                    <button type="submit" class="btn btn-primary">
                        <i class="fa fa-save me-1"></i> Guardar Cambios
                    </button>
                    <a href="{% url 'inicio' %}" class="btn btn-secondary">
                        <i class="fa fa-arrow-left me-1"></i> Cancelar
                    </a>
                </div>
            </form>
        </div>
    </div>
</section>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function () {
    const razasPorEspecie = {
        "Canina": ["Labrador Retriever", "Pastor Alemán", "Bulldog", "Golden Retriever", "Beagle", "Chihuahua", "Poodle", "Rottweiler", "Boxer", "Dálmata"],
        "Felina": ["Persa", "Siamés", "Maine Coon", "Bengalí", "Esfinge", "Angora", "British Shorthair", "Abisinio"],
        "Aviar": ["Perico", "Canario", "Loro", "Agapornis", "Cacatúa"],
        "Reptil": ["Iguana", "Serpiente", "Tortuga", "Camaleón"]
    };

    const razaActual = "{{ mascota.raza }}";

    function actualizarRazas() {
        const especie = $("#especie").val();
        const razaSelect = $("#raza");

        if (especie === "Otro") {
            $("#grupoRaza").html(`
                <label for="raza" class="form-label">Raza:</label>
                <input type="text" class="form-control" id="raza" name="raza" value="${razaActual}">
            `);
            return;
        }

        razaSelect.empty();
        razaSelect.append('<option value="">Seleccione una raza...</option>');
        if (razasPorEspecie[especie]) {
            razasPorEspecie[especie].forEach(raza => {
                razaSelect.append(`<option value="${raza}" ${raza === razaActual ? 'selected' : ''}>${raza}</option>`);
            });
        }
    }

    $("#especie").change(actualizarRazas);
    actualizarRazas();

    $("#formMascota").validate({
        rules: {
            nombre: { required: true, minlength: 2 },
            especie: { required: true },
            raza: { required: true },
            edad: { required: true, digits: true },
            sexo: { required: true }
        },
        messages: {
            nombre: { required: "Ingrese el nombre de la mascota" },
            especie: { required: "Seleccione una especie" },
            raza: { required: "Seleccione o escriba una raza" },
            edad: { required: "Ingrese la edad" },
            sexo: { required: "Seleccione el sexo" }
        }
    });
});
</script>
{% endblock %}
