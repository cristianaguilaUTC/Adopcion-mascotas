{% extends 'plantilla.html' %}

{% block title %}Nueva Mascota{% endblock %}

{% block contenido %}
<div class="page-heading">
    <h3 class="text-center mb-4">Agregar Nueva Mascota</h3>
</div>

<section class="section">
    <div class="card shadow p-4">
        <div class="card-body">
            <form id="formMascota" method="POST" enctype="multipart/form-data" novalidate>
                {% csrf_token %}

                <div class="mb-3">
                    <label for="nombre" class="form-label">Nombre:</label>
                    <input type="text" class="form-control" id="nombre" name="nombre" required>
                </div>

                <div class="mb-3">
                    <label for="especie" class="form-label">Especie:</label>
                    <select class="form-select" id="especie" name="especie" required>
                        <option value="">Seleccionar especie...</option>
                        <option value="Canina">Canina</option>
                        <option value="Felina">Felina</option>
                        <option value="Aviar">Aviar</option>
                        <option value="Reptil">Reptil</option>
                        <option value="Otro">Otro</option>
                    </select>
                </div>

                <div class="mb-3" id="grupoRaza">
                    <label for="raza" class="form-label">Raza:</label>
                    <select class="form-select" id="raza" name="raza">
                        <option value="">Seleccione una raza...</option>
                    </select>
                </div>

                <div class="mb-3">
                    <label for="edad" class="form-label">Edad:</label>
                    <input type="number" class="form-control" id="edad" name="edad" required>
                </div>

                <div class="mb-3">
                    <label for="sexo" class="form-label">Sexo:</label>
                    <select class="form-select" id="sexo" name="sexo" required>
                        <option value="">Seleccionar...</option>
                        <option value="Macho">Macho</option>
                        <option value="Hembra">Hembra</option>
                    </select>
                </div>

                <div class="mb-3">
                    <label for="descripcion" class="form-label">Descripción:</label>
                    <textarea class="form-control" id="descripcion" name="descripcion" rows="3"></textarea>
                </div>

                <div class="mb-3">
                    <label for="fecha_rescate" class="form-label">Fecha de rescate:</label>
                    <input type="date" class="form-control" id="fecha_rescate" name="fecha_rescate">
                </div>

                <div class="mb-3">
                    <label for="dueno" class="form-label">Dueño:</label>
                    <select class="form-select" id="dueno" name="dueno">
                        <option value="">Seleccionar dueño</option>
                        {% for persona in personas %}
                        <option value="{{ persona.id }}">{{ persona.nombre }} {{ persona.apellido }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="form-check mb-4">
                    <input type="checkbox" class="form-check-input" id="adoptado" name="adoptado">
                    <label class="form-check-label" for="adoptado">Adoptado</label>
                </div>

                <div class="mb-3">
                    <label for="foto" class="form-label">Foto de la Mascota:</label>
                    <input type="file" class="form-control" id="foto" name="foto" accept="image/*">
                </div>

                <div class="mb-3">
                    <label for="documento" class="form-label">Informe PDF:</label>
                    <input type="file" class="form-control" id="documento" name="documento" accept="application/pdf">
                </div>

                <div class="d-grid">
                    <button type="submit" class="btn btn-primary">
                        <i class="fa fa-save me-1"></i> Guardar Mascota
                    </button>
                </div>
            </form>
        </div>
    </div>
</section>
{% endblock %}

{% block extra_js %}
<script>
    $(document).ready(function () {
        const razasPorEspecie = {
            "Canina": ["Labrador Retriever", "Pastor Alemán", "Bulldog", "Golden Retriever", "Beagle", "Chihuahua", "Poodle", "Rottweiler", "Boxer", "Dálmata"],
            "Felina": ["Persa", "Siamés", "Maine Coon", "Bengalí", "Esfinge", "Angora", "British Shorthair", "Abisinio"],
            "Aviar": ["Perico", "Canario", "Loro", "Agapornis", "Cacatúa"],
            "Reptil": ["Iguana", "Serpiente", "Tortuga", "Camaleón"]
        };

        $("#especie").change(function () {
            const especie = $(this).val();
            const razaSelect = $("#raza");

            razaSelect.empty();
            if (razasPorEspecie[especie]) {
                razaSelect.prop("disabled", false);
                razaSelect.append('<option value="">Seleccione una raza...</option>');
                razasPorEspecie[especie].forEach(raza => {
                    razaSelect.append(`<option value="${raza}">${raza}</option>`);
                });
            } else if (especie === "Otro") {
                $("#grupoRaza").html(`
                <label for="raza" class="form-label">Raza:</label>
                <input type="text" class="form-control" id="raza" name="raza" placeholder="Ingrese la raza o tipo">
            `);
            } else {
                razaSelect.append('<option value="">Seleccione una especie primero</option>');
            }
        });

        $("#formMascota").validate({
            rules: {
                nombre: { required: true, minlength: 2 },
                especie: { required: true },
                raza: { required: true },
                edad: { required: true, digits: true },
                sexo: { required: true }
            },
            messages: {
                nombre: { required: "Ingrese el nombre de la mascota", minlength: "Nombre muy corto" },
                especie: { required: "Seleccione una especie" },
                raza: { required: "Seleccione o escriba una raza" },
                edad: { required: "Ingrese la edad", digits: "Sólo números" },
                sexo: { required: "Seleccione el sexo" }
            },
            errorElement: "div",
            errorClass: "invalid-feedback d-block",
            highlight: function (element) {
                var $el = $(element);
                $el.addClass("is-invalid");
                if ($el.is("select")) $el.addClass("is-invalid");
            },
            unhighlight: function (element) {
                var $el = $(element);
                $el.removeClass("is-invalid");
            },
            errorPlacement: function (error, element) {
                if (element.prop("type") === "file") {
                    error.insertAfter(element);
                } else if (element.is("select")) {
                    error.insertAfter(element);
                } else if (element.closest('.input-group').length) {
                    error.insertAfter(element.closest('.input-group'));
                } else {
                    error.insertAfter(element);
                }
            }
        });
    });
</script>
{% endblock %}